/*
 * Copyright (C) 2013 Panopta, Andrew Moffat
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(t){t.fn.wizard=function(t){return new Wizard(this,t)},t.fn.wizard.logging=!1;var e=function(t,e,i,n,r){this.wizard=t,this.index=i,this.prev=n,this.next=r,this.el=e,this.title=e.find("h3").first().text(),this.name=e.data("cardname")||this.title,this.nav=this._createNavElement(this.title,i),this._disabled=!1,this._loaded=!1,this._events={}};e.prototype={select:function(){this.log("selecting"),this.isSelected()||(this.nav.addClass("active"),this.el.show(),this._loaded||(this.trigger("loaded"),this.reload()),this.trigger("selected"));var t=this.wizard;return t.backButton.toggleClass("disabled",0==this.index),this.index>=t._cards.length-1?(this.log("on last card, changing next button to submit"),t.changeNextButton(t.args.buttons.submitText,"btn-success"),t._readyToSubmit=!0,t.trigger("readySubmit")):(t._readyToSubmit=!1,t.changeNextButton(t.args.buttons.nextText,"btn-primary")),this},_createNavElement:function(e,i){var n=t('<li class="wizard-nav-item"></li>'),r=t('<a class="wizard-nav-link"></a>');return r.data("navindex",i),n.append(r),r.append('<i class="icon-chevron-right"></i>'),r.append(e),n},markVisited:function(){return this.log("marking as visited"),this.nav.addClass("already-visited"),this.trigger("markVisited"),this},unmarkVisited:function(){return this.log("unmarking as visited"),this.nav.removeClass("already-visited"),this.trigger("unmarkVisited"),this},deselect:function(){return this.nav.removeClass("active"),this.el.hide(),this.trigger("deselect"),this},enable:function(){return this.log("enabling"),this.nav.addClass("active"),this._disabled=!1,this.trigger("enabled"),this},disable:function(t){return this.log("disabling"),this._disabled=!0,this.nav.removeClass("active already-visited"),t&&this.el.hide(),this.trigger("disabled"),this},isDisabled:function(){return this._disabled},alreadyVisited:function(){return this.nav.hasClass("already-visited")},isSelected:function(){return this.nav.hasClass("active")},reload:function(){return this._loaded=!0,this.trigger("reload"),this},on:function(){return this.wizard.on.apply(this,arguments)},trigger:function(){return this.callListener("on"+arguments[0]),this.wizard.trigger.apply(this,arguments)},toggleAlert:function(e,i){this.log("toggling alert to: "+i),i="undefined"==typeof i?!0:i,this.trigger(i?"showAlert":"hideAlert");var n,r=this.el.children("h3").first().next("div.alert");if(0==r.length){if(!i)return this;this.log("couldn't find existing alert div, creating one"),n=t("<div />"),n.addClass("alert"),n.addClass("hide"),n.insertAfter(this.el.find("h3").first())}else this.log("found existing alert div"),n=r.first();return i?(null!=e&&(this.log("setting alert msg to",e),n.html(e)),n.show()):n.hide(),this},callListener:function(t){t=t.toLowerCase(),this.log("looking for listener "+t);var e=window[this.el.data(t)];if(e){this.log("calling listener "+t);{this.wizard}try{{e(this)}}catch(i){this.log("exception calling listener "+t+": ",i)}}else this.log("didn't find listener "+t)},problem:function(t){this.nav.find("a").toggleClass("wizard-step-error",t)},validate:function(){var e=!1,i=this;this.el.find("[data-validate]").each(function(n,r){i.log("validating individiual inputs"),r=t(r);var a=r.data("validate");if(a){var s={status:!0,title:"Error",msg:""},o=window[a](r);if(t.extend(s,o),s.status){r.parent(".control-group").toggleClass("error",!1);try{r.popover("destroy")}catch(l){r.popover("hide")}}else e=!0,r.parent(".control-group").toggleClass("error",!0),i.wizard.errorPopover(r,s.msg)}}),this.log("after validating inputs, failures is",e);var n=window[this.el.data("validate")];if(n){this.log("running html-embedded card validator");var r=n(this);("undefined"==typeof r||null==r)&&(r=!0),r||(e=!0),this.log("after running html-embedded card validator, failures is",e)}this.log("running listener validator");var a=this.trigger("validate");("undefined"==typeof a||null==a)&&(a=!0),a||(e=!0),this.log("after running listener validator, failures is",e);var s=!e;return s?(this.log("validated, calling listeners"),this.trigger("validated")):(this.log("invalid"),this.trigger("invalid")),s},log:function(){if(window.console&&t.fn.wizard.logging){var e="card '"+this.name+"': ",i=[e];i.push.apply(i,arguments),console.log.apply(console,i)}},isActive:function(){return this.nav.hasClass("active")}},Wizard=function(e,i){var n=['<div class="modal hide wizard-modal" role="dialog">','<div class="wizard-modal-header modal-header">','<button class="wizard-close close" type="button">x</button>','<h3 class="wizard-title"></h3>','<span class="wizard-subtitle"></span>',"</div>",'<div class="pull-left wizard-steps">','<div class="wizard-nav-container">','<ul class="nav nav-list" style="padding-bottom:30px;">',"</ul>","</div>",'<div class="wizard-progress-container">',,'<div class="progress progress-striped">','<div class="bar"></div>',"</div>","</div>","</div>","<form>",'<div class="wizard-cards">','<div class="wizard-card-container">',"</div>",'<div class="wizard-modal-footer">','<div class="wizard-buttons-container">','<button class="btn wizard-cancel wizard-close" type="button">Cancel</button>','<div class="btn-group-single pull-right">','<button class="btn wizard-back" type="button">Back</button>','<button class="btn btn-primary wizard-next" type="button">Next</button>',"</div>","</div>","</div>","</div>","</form>","</div>"];this.args={submitUrl:"",width:750,showCancel:!1,progressBarCurrent:!1,increaseHeight:0,buttons:{cancelText:"Cancel",nextText:"Next",backText:"Back",submitText:"Submit",submittingText:"Submitting..."}},t.extend(this.args,i||{}),this.markup=t(e),this.submitCards=this.markup.find(".wizard-error,.wizard-failure,.wizard-success,.wizard-loading"),this.el=t(n.join("\n")),this.el.find(".wizard-card-container").append(this.markup.find(".wizard-card")).append(this.submitCards),t("body").append(this.el),this.closeButton=this.el.find("button.wizard-close"),this.footer=this.el.find(".wizard-modal-footer"),this.cancelButton=this.footer.find(".wizard-cancel"),this.backButton=this.footer.find(".wizard-back"),this.nextButton=this.footer.find(".wizard-next"),this.progress=this.el.find(".progress"),this._cards=[],this.cards={},this._readyToSubmit=!1,this.percentComplete=0,this._submitting=!1,this._events={},this._firstShow=!0,this._createCards(),this.nextButton.click(this,this._handleNextClick),this.backButton.click(this,this._handleBackClick),this.cancelButton.text(this.args.buttons.cancelText),this.backButton.text(this.args.buttons.backText),this.nextButton.text(this.args.buttons.nextText);var r=360,a=r+this.args.increaseHeight;this.el.find(".wizard-nav-container").css("height",a),this.el.find(".wizard-steps").css("height",a+65+"px"),this.el.find(".wizard-card").css("height",a-60+"px"),this.submitCards.css("height",a-60+"px"),this.el.css("margin-top",-(this.el.height()/2)),this.el.css("width",this.args.width),this.el.css("margin-left",-(this.args.width/2));var s=this;this.closeButton.click(function(){s.reset(),s.close(),s.trigger("closed")}),this.el.find(".wizard-steps").on("click","li.already-visited a.wizard-nav-link",this,function(e){var i=parseInt(t(e.target).data("navindex"));e.data.setCard(i)});var o=this.markup.children("h1").first();o.length&&this.setTitle(o.text()),this.on("submit",this._defaultSubmit)},Wizard.prototype={errorPopover:function(t,e){this.log("launching popover on",t);var i=t.popover({content:e,trigger:"manual"}).popover("show").next(".popover");return i.addClass("error-popover"),i},destroyPopover:function(e){e=t(e),e.parent(".control-group").toggleClass("error",!1);var i=e.prev();try{i.popover("destroy")}catch(n){i.popover("hide")}},hidePopovers:function(){this.log("hiding all popovers");var t=this;this.el.find(".error-popover").each(function(e,i){t.destroyPopover(i)})},eachCard:function(e){return t.each(this._cards,e),this},getActiveCard:function(){this.log("getting active card");var e=null;return t.each(this._cards,function(t,i){return i.isActive()?(e=i,!1):void 0}),e?this.log("found active card",e):this.log("couldn't find an active card"),e},setTitle:function(t){return this.log("setting title to",t),this.el.find(".wizard-title").first().text(t),this},setSubtitle:function(t){return this.log("setting subtitle to",t),this.el.find(".wizard-subtitle").first().text(t),this},changeNextButton:function(t,e){return this.log("changing next button, text: "+t,"class: "+e),"undefined"!=typeof e&&this.nextButton.removeClass("btn-success btn-primary"),e&&this.nextButton.addClass(e),this.nextButton.text(t),this},hide:function(){return this.log("hiding"),this.el.modal("hide"),this},close:function(){return this.log("closing"),this.el.modal("hide"),this},show:function(t){return this.log("showing"),this._firstShow&&(this.setCard(0),this._firstShow=!1),this.args.showCancel&&this.cancelButton.show(),this.el.modal(t),this},on:function(t,e){return this.log("adding listener to event "+t),this._events[t]=e,this},trigger:function(){var t=arguments[0],e=Array.prototype.slice.call(arguments);e.shift(),e.unshift(this),this.log("firing event "+t);var i=this._events[t],n=null;if("function"==typeof i){this.log("found event handler, calling "+t);try{n=i.apply(this,e)}catch(r){this.log("event handler "+t+" had an exception")}}else this.log("couldn't find an event handler for "+t);return n},reset:function(){return this.log("resetting"),this.updateProgressBar(0),this.hideSubmitCards(),this.setCard(0),this.lockCards(),this.enableNextButton(),this.showButtons(),this.hidePopovers(),this.trigger("reset"),this},log:function(){if(window.console&&t.fn.wizard.logging){var e="wizard "+this.el.id+": ",i=[e];i.push.apply(i,arguments),console.log.apply(console,i)}},_abstractIncrementStep:function(t,e){var i,n=this.getActiveCard();if(n)for(this.log("searching for valid next card");;){if(i=e(n)){if(this.log("looking at card",i.index),i.isDisabled()){this.log("card "+i.index+" is disabled/locked, continuing"),n=i;continue}return this.setCard(n.index+t)}this.log("next card is not defined, breaking");break}else this.log("current card is undefined")},incrementCard:function(){this.log("incrementing card");var t=this._abstractIncrementStep(1,function(t){return t.next});return this.trigger("incrementCard"),t},decrementCard:function(){this.log("decrementing card");var t=this._abstractIncrementStep(-1,function(t){return t.prev});return this.trigger("decrementCard"),t},setCard:function(t){this.log("setting card to "+t),this.hideSubmitCards();var e=this.getActiveCard();if(this._submitting)return this.log("we're submitting the wizard already, can't change cards"),e;var i=this._cards[t];if(i){if(i.isDisabled())return this.log("new card is currently disabled, returning"),e;if(e){if(t>e.index){for(var n=e,r=!1;n.index!=i.index;){if(n.index!=e.index&&(n.prev.deselect(),n.prev.markVisited(),n.select()),r=n.validate(),!r)return n;n=n.next}n.prev.deselect(),n.prev.markVisited()}e.deselect(),e.markVisited()}if(i.select(),this.args.progressBarCurrent)this.percentComplete=100*t/this._cards.length,this.updateProgressBar(this.percentComplete);else{var a=this.percentComplete;this.percentComplete=100*t/this._cards.length,this.percentComplete=Math.max(a,this.percentComplete),this.updateProgressBar(this.percentComplete)}return i}this.log("couldn't find card "+t)},updateProgressBar:function(t){this.log("updating progress to "+t+"%"),this.progress.find(".bar").css({width:t+"%"}),this.percentComplete=t,this.trigger("progressBar",t),100==t?(this.log("progress is 100, animating progress bar"),this.progress.addClass("active")):0==t&&(this.log("progress is 0, disabling animation"),this.progress.removeClass("active"))},getNextCard:function(){var t=this.getActiveCard();return t?t.next:void 0},lockCards:function(){return this.log("locking nav cards"),this.eachCard(function(t,e){e.unmarkVisited()}),this},disableCards:function(){return this.log("disabling all nav cards"),this.eachCard(function(t,e){e.disable()}),this},enableCards:function(){return this.log("enabling all nav cards"),this.eachCard(function(t,e){e.enable()}),this},hideCards:function(){return this.log("hiding cards"),this.eachCard(function(t,e){e.deselect()}),this.hideSubmitCards(),this},hideButtons:function(){return this.log("hiding buttons"),this.cancelButton.hide(),this.nextButton.hide(),this.backButton.hide(),this},showButtons:function(){return this.log("showing buttons"),this.args.showCancel&&this.cancelButton.show(),this.nextButton.show(),this.backButton.show(),this},getCard:function(e){var i=t(e).parents(".wizard-card").first()[0];if(i){var n=null;return this.eachCard(function(t,e){return i==e.el[0]?(n=e,!1):!0}),n}return null},_createCards:function(){var i=null,n=null,r=null,a=this,s=this,o=this.el.find(".wizard-cards .wizard-card");t.each(o,function(o,l){l=t(l),i=r,r=new e(a,l,o,i,n),s._cards.push(r),r.name&&(s.cards[r.name]=r),i&&(i.next=r),s.el.find(".wizard-steps .nav-list").append(r.nav)})},showSubmitCard:function(t){this.log("showing "+t+" submit card");var e=this.el.find(".wizard-"+t);e.length?(this.hideCards(),this.el.find(".wizard-"+t).show()):this.log("couldn't find submit card "+t)},hideSubmitCard:function(t){this.log("hiding "+t+" submit card"),this.el.find(".wizard-"+t).hide()},hideSubmitCards:function(){var e=this;t.each(["success","error","failure","loading"],function(t,i){e.hideSubmitCard(i)})},enableNextButton:function(){return this.log("enabling next button"),this.nextButton.removeAttr("disabled"),this},disableNextButton:function(){return this.log("disabling next button"),this.nextButton.attr("disabled","disabled"),this},serializeArray:function(){var t=this.el.children("form").first();return t.serializeArray()},serialize:function(){var t=this.el.children("form").first();return t.serialize()},submitSuccess:function(){this.log("submit success"),this._submitting=!1,this.showSubmitCard("success"),this.trigger("submitSuccess")},submitFailure:function(){this.log("submit failure"),this._submitting=!1,this.showSubmitCard("failure"),this.trigger("submitFailure")},submitError:function(){this.log("submit error"),this._submitting=!1,this.showSubmitCard("error"),this.trigger("submitError")},_submit:function(){this.log("submitting wizard"),this._submitting=!0,this.lockCards(),this.cancelButton.hide(),this.backButton.hide(),this.showSubmitCard("loading"),this.updateProgressBar(100),this.changeNextButton(this.args.buttons.submittingText,!1),this.disableNextButton();this.trigger("submit");this.trigger("loading")},_onNextClick:function(){this.log("handling 'next' button click");var t=this.getActiveCard();this._readyToSubmit&&t.validate()?this._submit():t=this.incrementCard()},_onBackClick:function(){this.log("handling 'back' button click");this.decrementCard()},_handleNextClick:function(t){var e=t.data;e._onNextClick.call(e)},_handleBackClick:function(t){var e=t.data;e._onBackClick.call(e)},_defaultSubmit:function(e){t.ajax({type:"POST",url:e.args.submitUrl,data:e.serialize(),dataType:"json",success:function(){e.submitSuccess(),e.hideButtons(),e.updateProgressBar(0)},error:function(){e.submitFailure(),e.hideButtons()}})}}}(window.jQuery);